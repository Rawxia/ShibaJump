<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Shiba Jump</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap');
        /* Pixel font for 8-bit text */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --bg-color: #f7f7f7;
            --text-color: #333;
            --accent-color: #ff6347;
            --shiba-size: 60px;
            --obstacle-size: 50px;
            --ground-height-percent: 25%;
            --ground-height: 0px; 
            
            /* Biome-specific colors (default to Sky) */
            --current-sky-color: #87CEEB; /* Sky Blue */
            --current-cloud-svg: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="250" height="250" viewBox="0 0 50 50"><path fill="%23FFFFFF" d="M41.9 23.3c-1-5.6-5.8-9.8-11.4-9.8-3.7 0-7 1.8-9.1 4.5-1.3-1.2-3-2-4.9-2-3.4 0-6.1 2.8-6.1 6.1 0 .6.1 1.2.3 1.8-4.3.5-7.6 4.1-7.6 8.5 0 4.7 3.8 8.5 8.5 8.5h29.5c4.1 0 7.5-3.4 7.5-7.5 0-3.9-3-7.1-6.8-7.5z"/></svg>');
            --current-ground-color: #e0e0e0;
            --current-ground-border-color: #ccc;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: var(--current-sky-color); /* Use biome color */
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s ease-in-out; /* Smooth biome transitions */
        }

        #game-container {
            width: 100%;
            max-width: 800px;
            height: 100vh;
            max-height: 400px;
            border-radius: 20px;
            background: var(--current-sky-color); /* Use biome color */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.5s ease-in-out; /* Smooth biome transitions */
        }

        #game-world {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            justify-content: center; 
            align-items: flex-end; 
        }
        
        #clouds {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background-image: var(--current-cloud-svg); /* Use biome cloud */
            background-repeat: repeat-x;
            opacity: 0.7;
            animation: moveClouds 25s linear infinite;
            transition: background-image 0.5s ease-in-out; /* Smooth cloud transitions */
        }

        #ground {
            width: 200%;
            height: var(--ground-height); 
            background: var(--current-ground-color); /* Use biome color */
            position: absolute;
            bottom: 0;
            left: 0;
            border-top: 2px solid var(--current-ground-border-color); /* Use biome color */
            animation: moveGround 4s linear infinite;
            transition: background 0.5s ease-in-out, border-top-color 0.5s ease-in-out; /* Smooth ground transitions */
        }
        
        #shiba-container {
            position: absolute;
            bottom: var(--ground-height); 
            left: calc(50% - (var(--shiba-size) / 2)); 
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #shiba {
            width: var(--shiba-size);
            height: var(--shiba-size);
            background-image: url('shiba.gif'); 
            background-size: contain;
            background-repeat: no-repeat;
            transition: transform 0.15s ease-out; 
        }

        #shiba-name {
            font-family: 'Press Start 2P', cursive; /* 8-bit font */
            font-size: 0.8em; /* Small 8-bit text */
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            position: absolute;
            top: -25px; /* Position above shiba */
            white-space: nowrap; /* Prevent text wrapping */
        }
        
        .invincible { animation: flash 0.5s linear infinite; }
        
        .particle {
            position: absolute;
            font-size: 20px;
            z-index: 20;
            animation: particle-poof 0.8s ease-out forwards;
        }

        .obstacle, .power-up, .toy-item {
            width: var(--obstacle-size);
            height: var(--obstacle-size);
            background-size: contain;
            background-repeat: no-repeat;
            position: absolute;
            font-size: var(--obstacle-size);
            line-height: 1;
            z-index: 10;
            animation: moveItem 3.5s linear;
        }
        
        .obstacle.ground-type, .power-up.ground-type, .toy-item.ground-type {
            bottom: var(--ground-height); 
        }

        .obstacle.flying-type, .power-up.flying-type, .toy-item.flying-type {
            bottom: calc(var(--ground-height) + 100px); 
            font-size: 60px; 
        }

        /* Toy specific styles */
        .toy-item {
            width: 70px; /* Make toys bigger */
            height: 70px; /* Make toys bigger */
            animation: moveItem 3.5s linear, wiggleToy 1s ease-in-out infinite; 
            font-size: 70px; /* Ensure emoji toys are big too */
        }
        .toy-item.Toy1 { background-image: url('Toy1.png'); }
        .toy-item.Toy2 { background-image: url('Toy2.png'); }
        .toy-item.Toy3 { background-image: url('Toy3.png'); }

        @keyframes wiggleToy {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(3deg); }
            100% { transform: rotate(0deg); }
        }

        /* Score & High Score positions */
        #score-container {
            position: absolute;
            top: 20px;
            left: 20px; /* Aligned with XP bar */
            font-size: 1.5em;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            z-index: 20;
            margin-top: 35px; /* Space below XP bar */
        }
        #high-score-container { 
            position: absolute;
            top: 20px;
            right: 20px; 
            font-size: 1.5em;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            z-index: 20;
        }

        #score #score-number {
            display: inline-block;
            transition: transform 0.1s ease-out, color 0.1s ease-out;
        }

        /* Score effects */
        .score-effect-1 { transform: scale(1.2); color: #FFFACD; } /* Lemon Chiffon */
        .score-effect-2 { transform: rotate(5deg); }
        .score-effect-3 { transform: translateY(-3px); }
        .score-effect-4 { color: #ADFF2F; } /* GreenYellow */

        #splash-screen, #game-over-screen, #intro-message {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        #splash-screen {
            background-color: var(--accent-color);
            color: white;
            transition: transform 0.8s cubic-bezier(0.86, 0, 0.07, 1);
            text-align: center;
            padding: 20px; 
            box-sizing: border-box; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #splash-screen.hidden { transform: translateY(-100%); }
        
        #splash-screen h1 {
            font-family: 'Press Start 2P', cursive; 
            font-size: clamp(2em, 8vw, 4em); 
            margin-bottom: 20px;
            text-shadow: 4px 4px #8B0000, 6px 6px #000; 
            color: #FFD700; 
            white-space: nowrap; 
            overflow: hidden; 
        }
        #splash-screen p { 
            font-size: clamp(0.9em, 2.5vw, 1.2em); 
            margin: 8px 0; 
            padding: 0 20px;
            line-height: 1.4; 
        }
        #splash-screen .chicken-message {
            font-size: clamp(1em, 3.5vw, 1.5em); /* Slightly larger */
            font-weight: bold;
            color: #FFD700; /* Gold color for visibility */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        #splash-screen .tagline {
            margin-top: 15px; 
            margin-bottom: 25px; 
            font-size: clamp(1.2em, 3vw, 1.5em);
            font-weight: 700;
        }

        #splash-screen .instagram-handle {
            font-size: clamp(0.8em, 2vw, 1em);
            color: rgba(255, 255, 255, 0.8);
            margin-top: 15px;
        }

        #splash-screen .high-score-crown {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.8em;
            color: #FFD700; 
            display: flex;
            align-items: center;
            gap: 5px; 
            font-family: 'Press Start 2P', cursive;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        #splash-screen .high-score-crown span {
            font-size: 0.8em; 
        }
        
        #xp-level-bar-container {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 100px; 
            height: 20px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.5);
            z-index: 101;
            display: flex;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7em;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        #xp-bar-fill {
            height: 100%;
            width: 0%;
            background-color: #ADD8E6; /* Light Blue XP */
            transition: width 0.3s ease-out;
            border-radius: 10px;
        }

        #xp-level-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 20px; 
        }
        
        .xp-gain-text {
            position: absolute;
            color: #FFD700; /* Gold */
            font-size: 1em;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            animation: xp-pop-fade 0.7s ease-out forwards;
            pointer-events: none; /* Make sure it doesn't block clicks */
            z-index: 102; /* Above XP bar */
            white-content: nowrap;
        }

        @keyframes xp-pop-fade {
            0% { transform: translateY(0px) scale(1); opacity: 1; }
            100% { transform: translateY(-20px) scale(0.8); opacity: 0; }
        }


        #splash-screen button {
            background-color: #fff;
            color: var(--accent-color);
            border: none;
            padding: 15px 30px;
            font-size: 1.5em;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 30px;
            animation: wiggle 2s infinite ease-in-out; /* Wiggle animation */
        }
        #splash-screen button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
        #splash-screen button.clicked {
            animation: button-pop 0.2s ease-out forwards; /* Pop effect */
        }

        #intro-message {
            color: var(--accent-color);
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }
        #intro-message h2 { font-size: 2.5em; margin: 0; }
        #intro-message p { font-size: 5em; margin: 0; font-weight: 700; }
        
        #game-over-screen {
            display: none;
            background-color: rgba(255, 255, 255, 0.9);
            text-align: center;
            color: var(--text-color);
            padding: 20px;
            box-sizing: border-box;
        }
        #game-over-screen h2 { font-size: 3em; margin: 0; color: var(--accent-color); }
        #game-over-screen p { font-size: 1.2em; margin: 10px 0; }
        #game-over-screen button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }
        #game-over-screen button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 99, 71, 0.4);
        }
        #game-over-screen a { margin-top: 20px; color: var(--accent-color); text-decoration: none; font-weight: 600; }

        #new-high-score-message {
            color: var(--accent-color);
            font-size: 1.5em;
            font-weight: 700;
            margin-top: 10px;
            display: none; 
            animation: bounceIn 0.8s ease-out;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        .confetti {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #f00; 
            animation: fall 3s ease-out forwards;
            opacity: 0;
            border-radius: 50%; 
        }
        @keyframes fall {
            0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(200vh) rotate(720deg); opacity: 0; }
        }

        /* Raindrop effect */
        .raindrop {
            position: absolute;
            width: 2px;
            height: 10px;
            background-color: rgba(173, 216, 230, 0.8); /* Light blue, slightly transparent */
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            animation: rain-fall 1s linear forwards;
            z-index: 5; /* Below obstacles but above ground/clouds */
        }
        @keyframes rain-fall {
            0% { transform: translateY(-10px); opacity: 0.8; }
            100% { transform: translateY(450px); opacity: 0; } /* Adjust 450px based on game container height */
        }

        #invincible-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Press Start 2P', cursive;
            font-size: 2em;
            color: #FFD700; /* Gold */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            z-index: 100;
            display: none; /* Controlled by JS */
            animation: invincibility-pulse 1s infinite alternate;
            white-space: nowrap; /* Prevent wrapping */
        }
        #invincible-message.visible {
            display: block;
        }
        @keyframes invincibility-pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
        }


        @keyframes moveGround { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        @keyframes moveClouds { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        @keyframes moveItem { from { left: 100%; } to { left: -100px; } } /* Renamed to moveItem for all collectibles */
        @keyframes flash { 50% { opacity: 0.3; } }
        @keyframes particle-poof {
            0% { transform: scale(1) translateY(0); opacity: 1; }
            100% { transform: scale(0) translateY(100px); opacity: 0; }
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-1deg); }
            75% { transform: rotate(1deg); }
        }

        @keyframes button-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .crown-pop {
            animation: crown-bounce 0.8s ease-out;
        }

        @keyframes crown-bounce {
            0% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(0.9); }
            75% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @media (max-width: 600px) {
            :root { --shiba-size: 50px; --obstacle-size: 40px; }
            #game-container { border-radius: 0; height: 100vh; max-height: 100%; }
            #score-container { font-size: 1em; right: auto; left: 10px; margin-top: 30px;} 
            #high-score-container { font-size: 1em; right: 10px;} 
            #intro-message h2 { font-size: 1.8em; }
            #intro-message p { font-size: 4em; }
            #game-over-screen h2 { font-size: 2.5em; }
            #game-over-screen p { font-size: 1.2em; }
            #splash-screen h1 { font-size: clamp(2em, 8vw, 3em); } 
            #splash-screen p { font-size: clamp(0.9em, 2.5vw, 1em); }
            #splash-screen .chicken-message { font-size: clamp(1em, 3vw, 1.3em); }
            #splash-screen .tagline { font-size: clamp(1.2em, 3vw, 1.2em); }
            #shiba-name { font-size: 0.7em; top: -20px;}
            #splash-screen button {
                padding: 10px 20px;
                font-size: 1.2em;
            }
            #splash-screen .high-score-crown {
                font-size: 1.5em;
                top: 10px;
                right: 10px;
            }
            #xp-level-bar-container {
                width: 80px;
                height: 18px;
                font-size: 0.6em;
                top: 10px;
                left: 10px;
            }
            #xp-level-text {
                line-height: 18px;
            }
            #invincible-message {
                font-size: 1.5em;
            }
            /* Adjust toy size for smaller screens */
            .toy-item {
                width: 50px; 
                height: 50px;
                font-size: 50px;
            }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="game-world">
            <div id="clouds"></div>
            <div id="ground"></div>
            <div id="shiba-container">
                <span id="shiba-name">Akari</span>
                <div id="shiba"></div>
            </div>
        </div>

        <div id="xp-level-bar-container">
            <div id="xp-bar-fill"></div>
            <span id="xp-level-text">Level: <span id="player-level">1</span></span>
        </div>
        <div id="score-container"><span>Score: </span><span id="score"><span id="score-number">0</span></span></div>
        <div id="high-score-container"><span>🏆 </span><span id="high-score">0</span></div>
        

        <div id="splash-screen">
            <h1>ShibaJump!</h1>
            <p>Tap for longer jumps and get the highest score!</p>
            <p class="chicken-message">Grab the 🍗 to become invincible!</p>
            <p>Collect Akari's toys for extra XP and bigger scores!</p>
            <p class="tagline">Can you help Akari find her way?</p>
            <div class="instagram-handle">@sebulique</div>
            <div class="high-score-crown">👑 <span id="splash-high-score">0</span></div>
            <button id="play-button">Play Game</button>
        </div>
        <div id="intro-message">
            <h2>Get ready to tap!</h2>
            <p id="countdown">3</p>
        </div>
        
        <div id="game-over-screen">
            <h2>Game Over</h2>
            <p>Your Score: <span id="final-score">0</span></p>
            <p>🏆 Best: <span id="final-high-score">0</span></p>
            <p id="new-high-score-message">Beat Your Best!</p>
            <button onclick="restartGame()">Play Again</button>
            <a href="https://www.instagram.com/sebulique" target="_blank">Visit my Instagram @sebulique</a>
        </div>

        <div id="invincible-message">Invincible!</div>
    </div>

    <script>
        const elements = {
            shibaContainer: document.getElementById('shiba-container'), 
            shiba: document.getElementById('shiba'),
            shibaName: document.getElementById('shiba-name'), 
            gameWorld: document.getElementById('game-world'),
            scoreDisplay: document.getElementById('score'),
            scoreNumber: document.getElementById('score-number'), 
            highScoreDisplay: document.getElementById('high-score'),
            splashScreen: document.getElementById('splash-screen'),
            playButton: document.getElementById('play-button'), 
            introMessage: document.getElementById('intro-message'),
            countdownDisplay: document.getElementById('countdown'),
            gameOverScreen: document.getElementById('game-over-screen'),
            finalScoreDisplay: document.getElementById('final-score'),
            finalHighScoreDisplay: document.getElementById('final-high-score'),
            newHighScoreMessage: document.getElementById('new-high-score-message'),
            ground: document.getElementById('ground'),
            clouds: document.getElementById('clouds'),
            gameContainer: document.getElementById('game-container'),
            body: document.body,
            splashHighScore: document.getElementById('splash-high-score'), 
            playerLevelDisplay: document.getElementById('player-level'),
            xpBarFill: document.getElementById('xp-bar-fill'),
            xpLevelText: document.getElementById('xp-level-text'),
            highScoreCrownIcon: document.querySelector('#high-score-container span:first-child'),
            invincibleMessage: document.getElementById('invincible-message') 
        };

        const state = {
            score: 0,
            highScore: localStorage.getItem('shibaHighScore') || 0,
            isJumping: false,
            isGameOver: true,
            isInvincible: false,
            gameLoopInterval: null,
            obstacleInterval: null,
            confettiInterval: null, 
            shibaY: 0, 
            velocityY: 0, 
            gravity: 0.8, 
            jumpStrength: -18, 
            maxHoldJumpBoost: -8, 
            jumpHoldTimer: null,
            groundHeight: 0, 
            flyingObstacleThreshold: 20,
            currentBiomeIndex: 0, 
            lastBiomeChangeScore: 0, 
            biomeChangeInterval: 5, 
            normalObstacleInterval: 2000, 
            playerXP: parseInt(localStorage.getItem('shibaPlayerXP')) || 0,
            playerLevel: parseInt(localStorage.getItem('shibaPlayerLevel')) || 1,
            xpToNextLevel: 1000,
            biomeOrder: [], 
            biomeCurrentIndexInOrder: 0,
            bubbleInterval: null, 
            rainInterval: null,
            baseGameSpeed: 4, 
            obstacleBaseSpeed: 3.5 
        };
        
        const EMOJIS = {
            invincibilityPowerUp: '🍗', 
            sky: {
                ground: ['🌳', '🪨', '🌲', '🪵'],
                flying: ['☁️', '🎈', '🦉']
            },
            desert: {
                ground: ['🌵', '🐍', '🏜️', '🦂'],
                flying: ['🦅', '☀️', '🌪️']
            },
            forest: {
                ground: ['🕷️', '🍄', '🌿', '🪵'],
                flying: ['🦉', '🦇', '🦋']
            },
            snow: {
                ground: ['🎄', '⛄', '🧊', '🛷'], 
                flying: ['❄️', '🌨️', '🌬️']
            },
            underwater: {
                ground: ['🦀', '🐡', '🐙', '🐚'], 
                flying: ['🐠', '🦑', '🐡'] 
            },
            night: {
                ground: ['🐺', '🦉', '🕸️', '🌙'],
                flying: ['🦇', '🌌', '🌟']
            },
            rainyForest: {
                ground: ['🐸', '🍄', '💦', '🪨'], 
                flying: ['🌧️', '⚡', '🦅'] 
            }
        };

        const TOY_IMAGES = ['Toy1.png', 'Toy2.png', 'Toy3.png'];

        const CONFETTI_COLORS = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f', '#FFD700', '#C0C0C0']; 

        // Biome definitions
        const BIOMES = [
            {
                name: "Sky",
                skyColor: "#87CEEB",
                cloudSvg: 'url("data:image/svg+xml;utf8,<svg xmlns=\\"http://www.w3.org/2000/svg\\" width=\\"250\\" height=\\"250\\" viewBox=\\"0 0 50 50\\"><path fill=\\"%23FFFFFF\\" d=\\"M41.9 23.3c-1-5.6-5.8-9.8-11.4-9.8-3.7 0-7 1.8-9.1 4.5-1.3-1.2-3-2-4.9-2-3.4 0-6.1 2.8-6.1 6.1 0 .6.1 1.2.3 1.8-4.3.5-7.6 4.1-7.6 8.5 0 4.7 3.8 8.5 8.5 8.5h29.5c4.1 0 7.5-3.4 7.5-7.5 0-3.9-3-7.1-6.8-7.5z\\"/></svg>")',
                groundColor: "#e0e0e0",
                groundBorderColor: "#ccc",
                groundObstacles: EMOJIS.sky.ground,
                flyingObstacles: EMOJIS.sky.flying,
                specialEffect: null 
            },
            {
                name: "Desert",
                skyColor: "#FFD700", 
                cloudSvg: 'url("data:image/svg+xml;utf8,<svg xmlns=\\"http://www.w3.org/2000/svg\\" width=\\"250\\" height=\\"250\\" viewBox=\\"0 0 50 50\\"><path fill=\\"%23FFD700\\" d=\\"M41.9 23.3c-1-5.6-5.8-9.8-11.4-9.8-3.7 0-7 1.8-9.1 4.5-1.3-1.2-3-2-4.9-2-3.4 0-6.1 2.8-6.1 6.1 0 .6.1 1.2.3 1.8-4.3.5-7.6 4.1-7.6 8.5 0 4.7 3.8 8.5 8.5 8.5h29.5c4.1 0 7.5-3.4 7.5-7.5 0-3.9-3-7.1-6.8-7.5z\\"/></svg>")', 
                groundColor: "#F4A460", 
                groundBorderColor: "#CD853F", 
                groundObstacles: EMOJIS.desert.ground,
                flyingObstacles: EMOJIS.desert.flying,
                specialEffect: null
            },
            {
                name: "Forest",
                skyColor: "#8FBC8F", 
                cloudSvg: 'url("data:image/svg+xml;utf8,<svg xmlns=\\"http://www.w3.org/2000/svg\\" width=\\"250\\" height=\\"250\\" viewBox=\\"0 0 50 50\\"><path fill=\\"%23ADD8E6\\" d=\\"M41.9 23.3c-1-5.6-5.8-9.8-11.4-9.8-3.7 0-7 1.8-9.1 4.5-1.3-1.2-3-2-4.9-2-3.4 0-6.1 2.8-6.1 6.1 0 .6.1 1.2.3 1.8-4.3.5-7.6 4.1-7.6 8.5 0 4.7 3.8 8.5 8.5 8.5h29.5c4.1 0 7.5-3.4 7.5-7.5 0-3.9-3-7.1-6.8-7.5z\\"/></svg>")', 
                groundColor: "#556B2F", 
                groundBorderColor: "#6B8E23", 
                groundObstacles: EMOJIS.forest.ground,
                flyingObstacles: EMOJIS.forest.flying,
                specialEffect: null
            },
            {
                name: "Snow",
                skyColor: "#B0E0E6", 
                cloudSvg: 'url("data:image/svg+xml;utf8,<svg xmlns=\\"http://www.w3.org/2000/svg\\" width=\\"250\\" height=\\"250\\" viewBox=\\"0 0 50 50\\"><path fill=\\"%23F0F8FF\\" d=\\"M41.9 23.3c-1-5.6-5.8-9.8-11.4-9.8-3.7 0-7 1.8-9.1 4.5-1.3-1.2-3-2-4.9-2-3.4 0-6.1 2.8-6.1 6.1 0 .6.1 1.2.3 1.8-4.3.5-7.6 4.1-7.6 8.5 0 4.7 3.8 8.5 8.5 8.5h29.5c4.1 0 7.5-3.4 7.5-7.5 0-3.9-3-7.1-6.8-7.5z\\"/></svg>")', 
                groundColor: "#F0F8FF", 
                groundBorderColor: "#D3D3D3", 
                groundObstacles: EMOJIS.snow.ground,
                flyingObstacles: EMOJIS.snow.flying,
                specialEffect: null
            },
            {
                name: "Underwater",
                skyColor: "#4682B4", 
                cloudSvg: 'none', 
                groundColor: "#008B8B", 
                groundBorderColor: "#20B2AA", 
                groundObstacles: EMOJIS.underwater.ground,
                flyingObstacles: EMOJIS.underwater.flying,
                specialEffect: 'bubbles' 
            },
            {
                name: "Night",
                skyColor: "#1A2A3A", 
                cloudSvg: 'url("data:image/svg+xml;utf8,<svg xmlns=\\"http://www.w3.org/2000/svg\\" width=\\"250\\" height=\\"250\\" viewBox=\\"0 0 50 50\\"><path fill=\\"%23778899\\" d=\\"M41.9 23.3c-1-5.6-5.8-9.8-11.4-9.8-3.7 0-7 1.8-9.1 4.5-1.3-1.2-3-2-4.9-2-3.4 0-6.1 2.8-6.1 6.1 0 .6.1 1.2.3 1.8-4.3.5-7.6 4.1-7.6 8.5 0 4.7 3.8 8.5 8.5 8.5h29.5c4.1 0 7.5-3.4 7.5-7.5 0-3.9-3-7.1-6.8-7.5z\\"/></svg>")', 
                groundColor: "#36454F", 
                groundBorderColor: "#2F4F4F", 
                groundObstacles: EMOJIS.night.ground,
                flyingObstacles: EMOJIS.night.flying,
                specialEffect: null
            },
            {
                name: "Rainy Forest",
                skyColor: "#5F9EA0", 
                cloudSvg: 'url("data:image/svg+xml;utf8,<svg xmlns=\\"http://www.w3.org/2000/svg\\" width=\\"250\\" height=\\"250\\" viewBox=\\"0 0 50 50\\"><path fill=\\"%23778899\\" d=\\"M41.9 23.3c-1-5.6-5.8-9.8-11.4-9.8-3.7 0-7 1.8-9.1 4.5-1.3-1.2-3-2-4.9-2-3.4 0-6.1 2.8-6.1 6.1 0 .6.1 1.2.3 1.8-4.3.5-7.6 4.1-7.6 8.5 0 4.7 3.8 8.5 8.5 8.5h29.5c4.1 0 7.5-3.4 7.5-7.5 0-3.9-3-7.1-6.8-7.5z\\"/></svg>")', 
                groundColor: "#4F6F4F", 
                groundBorderColor: "#364F36", 
                groundObstacles: EMOJIS.rainyForest.ground,
                flyingObstacles: EMOJIS.rainyForest.flying,
                specialEffect: 'rain'
            }
        ];

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateBiomeOrder() {
            const biomeIndexes = Array.from({ length: BIOMES.length }, (_, i) => i);
            shuffleArray(biomeIndexes);
            state.biomeOrder = biomeIndexes;
            state.biomeCurrentIndexInOrder = 0;
        }

        function setBiome(index) {
            const biome = BIOMES[index];
            if (!biome) return; 

            document.documentElement.style.setProperty('--current-sky-color', biome.skyColor);
            document.documentElement.style.setProperty('--current-cloud-svg', biome.cloudSvg);
            document.documentElement.style.setProperty('--current-ground-color', biome.groundColor);
            document.documentElement.style.setProperty('--current-ground-border-color', biome.groundBorderColor);
            
            elements.clouds.style.display = biome.cloudSvg === 'none' ? 'none' : 'block';

            document.querySelectorAll('.special-effect-bubble').forEach(el => el.remove());
            document.querySelectorAll('.raindrop').forEach(el => el.remove());
            if (state.bubbleInterval) clearInterval(state.bubbleInterval);
            if (state.rainInterval) clearInterval(state.rainInterval);


            if (biome.specialEffect === 'bubbles') {
                startBubbleEffect();
            } else if (biome.specialEffect === 'rain') {
                startRainEffect();
            }
        }

        function startBubbleEffect() {
            state.bubbleInterval = setInterval(() => {
                if (state.isGameOver) {
                    clearInterval(state.bubbleInterval);
                    return;
                }
                const bubble = document.createElement('div');
                bubble.classList.add('special-effect-bubble');
                bubble.style.position = 'absolute';
                bubble.style.width = `${Math.random() * 10 + 5}px`;
                bubble.style.height = bubble.style.width;
                bubble.style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
                bubble.style.borderRadius = '50%';
                bubble.style.bottom = `${state.groundHeight}px`; 
                bubble.style.left = `${Math.random() * 100}%`;
                bubble.style.opacity = 0;
                
                const driftAmount = Math.random() > 0.5 ? 20 : -20;
                bubble.style.setProperty('--bubble-drift', `${driftAmount}px`); 
                bubble.style.animation = `bubble-float ${Math.random() * 8 + 4}s linear forwards`;
                
                elements.gameWorld.appendChild(bubble);

                setTimeout(() => bubble.remove(), parseFloat(bubble.style.animationDuration) * 1000); 
            }, 300); 
        }

        function startRainEffect() {
            state.rainInterval = setInterval(() => {
                if (state.isGameOver) {
                    clearInterval(state.rainInterval);
                    return;
                }
                const raindrop = document.createElement('div');
                raindrop.classList.add('raindrop');
                raindrop.style.left = `${Math.random() * 100}%`;
                raindrop.style.animationDuration = `${Math.random() * 0.8 + 0.5}s`; 
                raindrop.style.animationDelay = `${Math.random() * 1}s`; 
                elements.gameWorld.appendChild(raindrop);

                setTimeout(() => raindrop.remove(), parseFloat(raindrop.style.animationDuration) * 1000 + parseFloat(raindrop.style.animationDelay) * 1000);
            }, 50); 
        }
        
        const styleSheet = document.styleSheets[0];
        styleSheet.insertRule(`
            @keyframes bubble-float {
                0% { transform: translateY(0) translateX(0); opacity: 0; }
                20% { opacity: 1; }
                100% { transform: translateY(-300px) translateX(var(--bubble-drift)); opacity: 0; }
            }
        `, styleSheet.cssRules.length);


        function setDynamicGroundHeight() {
            const gameContainerHeight = elements.gameContainer.clientHeight;
            state.groundHeight = gameContainerHeight * (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ground-height-percent')) / 100);
            document.documentElement.style.setProperty('--ground-height', `${state.groundHeight}px`);
            
            if (state.shibaY <= state.groundHeight) {
                state.shibaY = state.groundHeight;
                elements.shibaContainer.style.bottom = `${state.shibaY}px`;
            }

            document.querySelectorAll('.obstacle.ground-type, .power-up.ground-type, .toy-item.ground-type').forEach(el => {
                el.style.bottom = `${state.groundHeight}px`;
            });
            document.querySelectorAll('.obstacle.flying-type, .power-up.flying-type, .toy-item.flying-type').forEach(el => {
                el.style.bottom = `calc(${state.groundHeight}px + 80px + ${Math.random() * 70}px)`; 
            });
        }

        function init() {
            setDynamicGroundHeight(); 
            window.addEventListener('resize', setDynamicGroundHeight); 

            state.highScore = localStorage.getItem('shibaHighScore') || 0;
            state.playerXP = parseInt(localStorage.getItem('shibaPlayerXP')) || 0;
            state.playerLevel = parseInt(localStorage.getItem('shibaPlayerLevel')) || 1;

            elements.highScoreDisplay.textContent = state.highScore;
            elements.splashHighScore.textContent = state.highScore; 
            updateXPDisplay();

            elements.playButton.addEventListener('click', handlePlayButtonClick);
            elements.playButton.addEventListener('touchstart', handlePlayButtonClick);
        }

        function handlePlayButtonClick(e) {
            e.preventDefault(); 
            elements.playButton.classList.add('clicked'); 
            elements.playButton.style.animation = 'none'; 
            setTimeout(() => {
                elements.splashScreen.classList.add('hidden');
                elements.playButton.removeEventListener('click', handlePlayButtonClick);
                elements.playButton.removeEventListener('touchstart', handlePlayButtonClick);
                setTimeout(startIntro, 800);
            }, 200); 
        }

        function startIntro() {
            elements.introMessage.style.opacity = '1';
            let count = 3;
            elements.countdownDisplay.textContent = count;
            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    elements.countdownDisplay.textContent = count;
                } else {
                    clearInterval(countdownInterval);
                    elements.introMessage.style.opacity = '0';
                    setTimeout(startGame, 500);
                }
            }, 1000);
        }

        function startGame() {
            state.isGameOver = false;
            state.score = 0;
            state.lastBiomeChangeScore = 0; 
            elements.scoreNumber.textContent = state.score; 
            elements.gameOverScreen.style.display = 'none';
            elements.newHighScoreMessage.style.display = 'none';
            elements.playButton.classList.remove('clicked'); 
            elements.invincibleMessage.classList.remove('visible'); // Hide message at start

            ['ground', 'clouds'].forEach(id => elements[id].style.animationPlayState = 'running');

            state.shibaY = state.groundHeight; 
            state.velocityY = 0;
            elements.shibaContainer.style.bottom = `${state.shibaY}px`; 
            elements.shiba.style.transform = `translateY(0px)`; 

            generateBiomeOrder();
            state.biomeCurrentIndexInOrder = 0;
            setBiome(state.biomeOrder[state.biomeCurrentIndexInOrder]);

            document.addEventListener('keydown', handleJumpStart);
            document.addEventListener('keyup', handleJumpEnd);
            elements.gameContainer.addEventListener('touchstart', handleJumpStart, { passive: false });
            elements.gameContainer.addEventListener('touchend', handleJumpEnd, { passive: false });
            elements.gameContainer.addEventListener('mousedown', handleJumpStart);
            elements.gameContainer.addEventListener('mouseup', handleJumpEnd);
            
            document.querySelectorAll('.obstacle, .power-up, .toy-item, .special-effect-bubble, .raindrop').forEach(el => el.remove());
            
            state.gameLoopInterval = setInterval(gameLoop, 20);
            state.obstacleInterval = setInterval(createItem, state.normalObstacleInterval);
        }

        const handleJumpStart = (e) => {
            const isKeyEvent = e.code === 'Space';
            const isMouseEvent = e.type === 'mousedown';
            const isTouchEvent = e.type === 'touchstart';

            const isGameAreaClick = elements.gameContainer.contains(e.target) && !e.target.closest('button');

            if (!state.isGameOver && !state.isJumping && (isKeyEvent || (isGameAreaClick && (isMouseEvent || isTouchEvent)))) {
                e.preventDefault(); 
                state.isJumping = true;
                state.velocityY = state.jumpStrength; 
                elements.shiba.style.transform = `translateY(0px) rotate(-10deg)`; // Tilt up
                
                state.jumpHoldTimer = setTimeout(() => {
                    if (state.isJumping) { 
                        state.velocityY += state.maxHoldJumpBoost; 
                    }
                }, 50); 
            }
        };

        const handleJumpEnd = (e) => {
            const isKeyEvent = e.code === 'Space';
            const isMouseEvent = e.type === 'mouseup';
            const isTouchEvent = e.type === 'touchend'; 

            const isGameAreaClickRelease = elements.gameContainer.contains(e.target) && !e.target.closest('button');

            if (state.isJumping && (isKeyEvent || (isGameAreaClickRelease && (isMouseEvent || isTouchEvent)))) {
                if (state.jumpHoldTimer) {
                    clearTimeout(state.jumpHoldTimer);
                    state.jumpHoldTimer = null;
                }
                if (state.velocityY < 0) { 
                    state.velocityY *= 0.5; 
                }
            }
        };


        function createItem() {
            if (state.isGameOver) return;
            
            const item = document.createElement('div');
            const currentBiome = BIOMES[state.biomeOrder[state.biomeCurrentIndexInOrder]];

            const randomChance = Math.random();
            const isChickenPowerUp = randomChance < 0.05; // 5% chance for chicken
            const isToyItem = !isChickenPowerUp && randomChance < 0.25; // If not chicken, 20% chance for toy (total 0.05 + 0.20 = 0.25)

            let isFlying = Math.random() < 0.5; 
            if (state.score < state.flyingObstacleThreshold) {
                isFlying = false; // Force ground items until threshold
            }

            if (isChickenPowerUp) {
                item.classList.add('power-up');
                item.textContent = EMOJIS.invincibilityPowerUp;
                if (isFlying) item.classList.add('flying-type');
                else item.classList.add('ground-type');
            } else if (isToyItem) {
                item.classList.add('toy-item');
                const randomToy = TOY_IMAGES[Math.floor(Math.random() * TOY_IMAGES.length)];
                item.classList.add(randomToy.replace('.png', '')); // Add class like 'Toy1'
                item.style.backgroundImage = `url('${randomToy}')`;
                if (isFlying) item.classList.add('flying-type');
                else item.classList.add('ground-type');
            }
            else {
                item.classList.add('obstacle');
                if (isFlying) {
                    item.classList.add('flying-type');
                    item.textContent = currentBiome.flyingObstacles[Math.floor(Math.random() * currentBiome.flyingObstacles.length)];
                } else {
                    item.classList.add('ground-type');
                    item.textContent = currentBiome.groundObstacles[Math.floor(Math.random() * currentBiome.groundObstacles.length)];
                }
            }
            
            elements.gameWorld.appendChild(item);

            const speedMultiplier = 1 - (state.score * 0.005); 
            let animationSpeed = Math.max(1.5, state.obstacleBaseSpeed * speedMultiplier); 
            
            item.style.animationDuration = `${animationSpeed}s`;

            if (item.classList.contains('flying-type')) {
                item.style.bottom = `calc(${state.groundHeight}px + 80px + ${Math.random() * 70}px)`; 
                if (item.classList.contains('toy-item')) item.style.fontSize = `var(--obstacle-size)`; // Ensure toy images use size variable
            } else {
                item.style.bottom = `${state.groundHeight}px`; 
            }


            const itemPassTimer = setTimeout(() => {
                if (item.parentNode && !item.hasAttribute('data-collided')) {
                    if (item.classList.contains('obstacle')) { 
                        updateScore(1, 10); // Normal obstacle: 1 score, 10 XP
                    }
                    item.remove();
                }
            }, animationSpeed * 1000);

            item.dataset.itemPassTimer = itemPassTimer;
        }

        function updateScore(scoreAmount = 1, xpAmount = 0) {
            state.score += scoreAmount;
            elements.scoreNumber.textContent = state.score;
            applyScoreEffect();
            checkConfetti();
            checkBiomeChange(); 
            checkGameSpeed(); 
            if (xpAmount > 0) {
                addXP(xpAmount);
            }
        }

        function checkGameSpeed() {
            const speedMultiplier = 1 - (state.score * 0.005); 
            const newGroundAnimationDuration = Math.max(2, state.baseGameSpeed * speedMultiplier);
            const newCloudAnimationDuration = Math.max(10, 25 * speedMultiplier);

            elements.ground.style.animationDuration = `${newGroundAnimationDuration}s`;
            elements.clouds.style.animationDuration = `${newCloudAnimationDuration}s`;
        }


        const scoreEffects = ['score-effect-1', 'score-effect-2', 'score-effect-3', 'score-effect-4'];
        function applyScoreEffect() {
            const randomEffect = scoreEffects[Math.floor(Math.random() * scoreEffects.length)];
            elements.scoreNumber.classList.add(randomEffect);
            setTimeout(() => {
                elements.scoreNumber.classList.remove(randomEffect);
            }, 150); 
        }

        function checkConfetti() {
            if (state.score > 0 && state.score % 10 === 0) {
                createConfetti();
            }
        }

        function checkBiomeChange() {
            if (state.score > 0 && (state.score % state.biomeChangeInterval === 0) && (state.score !== state.lastBiomeChangeScore)) { 
                state.biomeCurrentIndexInOrder = (state.biomeCurrentIndexInOrder + 1) % BIOMES.length; 
                setBiome(state.biomeOrder[state.biomeCurrentIndexInOrder]);
                state.lastBiomeChangeScore = state.score;
            }
        }

        function addXP(amount) {
            state.playerXP += amount;
            if (state.playerXP >= state.xpToNextLevel) {
                state.playerLevel++;
                state.playerXP -= state.xpToNextLevel; 
            }
            localStorage.setItem('shibaPlayerXP', state.playerXP);
            localStorage.setItem('shibaPlayerLevel', state.playerLevel);
            updateXPDisplay(amount); 
        }

        function updateXPDisplay(xpGained = 0) {
            const xpPercentage = (state.playerXP / state.xpToNextLevel) * 100;
            elements.xpBarFill.style.width = `${xpPercentage}%`;
            elements.xpLevelText.textContent = `Level: ${state.playerLevel}`;

            if (xpGained > 0) {
                const xpText = document.createElement('span');
                xpText.classList.add('xp-gain-text');
                xpText.textContent = `+${xpGained} XP`;
                const barRect = elements.xpLevelText.getBoundingClientRect();
                const containerRect = elements.gameContainer.getBoundingClientRect();

                xpText.style.left = `${(barRect.left - containerRect.left) + barRect.width / 2}px`;
                xpText.style.top = `${(barRect.top - containerRect.top) - 10}px`; 

                elements.gameWorld.appendChild(xpText); 
                setTimeout(() => xpText.remove(), 700);
            }
        }

        function gameLoop() {
            state.velocityY += state.gravity;
            state.shibaY -= state.velocityY; 

            if (state.shibaY <= state.groundHeight) {
                state.shibaY = state.groundHeight;
                state.velocityY = 0;
                state.isJumping = false; 
                elements.shiba.style.transform = `translateY(0px) rotate(0deg)`; 
                if (state.jumpHoldTimer) {
                    clearTimeout(state.jumpHoldTimer);
                    state.jumpHoldTimer = null;
                }
            } else if (state.velocityY > 0) { 
                elements.shiba.style.transform = `translateY(0px) rotate(10deg)`; 
            }


            elements.shibaContainer.style.bottom = `${state.shibaY}px`;

            checkCollisions();
        }

        function checkCollisions() {
            const shibaRect = elements.shibaContainer.getBoundingClientRect();
            document.querySelectorAll('.obstacle, .power-up, .toy-item').forEach(item => {
                const itemRect = item.getBoundingClientRect();
                
                if (itemRect.right > 0 && !item.hasAttribute('data-collided')) {
                    const collisionOverlapFactor = 0.15; // Adjusted for better accuracy
                    if (shibaRect.right > itemRect.left + (itemRect.width * collisionOverlapFactor) &&
                        shibaRect.left < itemRect.right - (itemRect.width * collisionOverlapFactor) &&
                        shibaRect.bottom > itemRect.top + (itemRect.height * collisionOverlapFactor) &&
                        shibaRect.top < itemRect.bottom - (itemRect.height * collisionOverlapFactor)) {
                        
                        item.setAttribute('data-collided', 'true');
                        clearTimeout(item.dataset.itemPassTimer);
                        
                        if (item.classList.contains('power-up')) { 
                            activateInvincibility();
                            item.remove(); 
                            return; // Stop further checks for this item
                        } else if (item.classList.contains('toy-item')) {
                            updateScore(5, 100); // 5 score, 100 XP for toys
                            item.remove();
                            return; // Stop further checks for this item
                        }
                        // Only if it's an obstacle
                        else if (item.classList.contains('obstacle')) { 
                            if (!state.isInvincible) {
                                endGame();
                            } else {
                                item.remove(); // Remove obstacle if invincible
                            }
                            return; // Stop further checks for this item
                        }
                    }
                }
            });
        }
        
        function activateInvincibility() {
            state.isInvincible = true;
            elements.shiba.classList.add('invincible');
            elements.invincibleMessage.classList.add('visible'); // Show invincible message

            setTimeout(() => {
                state.isInvincible = false;
                elements.shiba.classList.remove('invincible');
                elements.invincibleMessage.classList.remove('visible'); // Hide invincible message
            }, 5000); 
        }
        
        function createPoofEffect() {
            const shibaRect = elements.shiba.getBoundingClientRect();
            const containerRect = elements.gameContainer.getBoundingClientRect();
            for (let i = 0; i < 15; i++) {
                const p = document.createElement('div');
                p.textContent = '🐕';
                p.classList.add('particle');
                p.style.top = (shibaRect.top - containerRect.top + shibaRect.height / 2) + 'px';
                p.style.left = (shibaRect.left - containerRect.left + shibaRect.width / 2) + 'px';
                p.style.transform = `rotate(${Math.random() * 360}deg) translateX(${Math.random() * 60 - 30}px) translateY(${Math.random() * 60 - 30}px)`;
                elements.gameWorld.appendChild(p);
                setTimeout(() => p.remove(), 800);
            }
        }

        function createConfetti() {
            const numConfetti = 50;
            const containerRect = elements.gameContainer.getBoundingClientRect();
            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.backgroundColor = CONFETTI_COLORS[Math.floor(Math.random() * CONFETTI_COLORS.length)];
                confetti.style.left = Math.random() * containerRect.width + 'px';
                confetti.style.top = (Math.random() * -containerRect.height / 2) + 'px'; 
                confetti.style.animationDelay = (Math.random() * 0.8) + 's';
                confetti.style.animationDuration = (2 + Math.random() * 1.5) + 's'; 
                
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;

                elements.gameWorld.appendChild(confetti);
                setTimeout(() => confetti.remove(), parseFloat(confetti.style.animationDuration) * 1000 + parseFloat(confetti.style.animationDelay) * 1000);
            }
        }


        function endGame() {
            if (state.isGameOver) return;
            state.isGameOver = true;
            
            if (navigator.vibrate) navigator.vibrate(200);
            
            createPoofEffect();
            elements.shibaContainer.style.display = 'none'; 
            elements.invincibleMessage.classList.remove('visible'); // Hide invincible message on game over

            clearInterval(state.gameLoopInterval);
            clearInterval(state.obstacleInterval);
            if (state.bubbleInterval) clearInterval(state.bubbleInterval);
            if (state.rainInterval) clearInterval(state.rainInterval);
            
            ['ground', 'clouds'].forEach(id => elements[id].style.animationPlayState = 'paused');
            document.querySelectorAll('.obstacle, .power-up, .toy-item, .special-effect-bubble, .raindrop').forEach(el => {
                el.style.animationPlayState = 'paused';
                clearTimeout(el.dataset.itemPassTimer); // Renamed from obstaclePassTimer
            });
            
            document.removeEventListener('keydown', handleJumpStart);
            document.removeEventListener('keyup', handleJumpEnd);
            elements.gameContainer.removeEventListener('touchstart', handleJumpStart);
            elements.gameContainer.removeEventListener('touchend', handleJumpEnd);
            elements.gameContainer.removeEventListener('mousedown', handleJumpStart);
            elements.gameContainer.removeEventListener('mouseup', handleJumpEnd);

            let newHighScoreSet = false;
            if (state.score > state.highScore) {
                state.highScore = state.score;
                localStorage.setItem('shibaHighScore', state.highScore);
                elements.highScoreDisplay.textContent = state.highScore;
                elements.splashHighScore.textContent = state.highScore; 
                newHighScoreSet = true;
                addXP(500); 
                elements.highScoreCrownIcon.classList.add('crown-pop'); 
            } else {
                elements.highScoreCrownIcon.classList.remove('crown-pop'); 
            }

            elements.finalScoreDisplay.textContent = state.score;
            elements.finalHighScoreDisplay.textContent = state.highScore;
            elements.gameOverScreen.style.display = 'flex';

            if (newHighScoreSet) {
                elements.newHighScoreMessage.style.display = 'block';
                createConfetti();
            } else {
                elements.newHighScoreMessage.style.display = 'none';
            }
        }

        function restartGame() {
            document.querySelectorAll('.particle').forEach(el => el.remove());
            document.querySelectorAll('.obstacle, .power-up, .toy-item, .special-effect-bubble, .raindrop').forEach(el => el.remove());
            document.querySelectorAll('.confetti').forEach(el => el.remove());
            document.querySelectorAll('.xp-gain-text').forEach(el => el.remove()); 

            elements.shibaContainer.style.display = 'flex'; 
            elements.shiba.classList.remove('invincible');
            state.isInvincible = false;
            elements.invincibleMessage.classList.remove('visible'); // Ensure message is hidden on restart
            
            state.isGameOver = true;
            state.score = 0;
            state.lastBiomeChangeScore = 0; 
            elements.scoreNumber.textContent = 0;
            
            elements.gameOverScreen.style.display = 'none';
            elements.newHighScoreMessage.style.display = 'none';
            elements.highScoreCrownIcon.classList.remove('crown-pop'); 

            if (state.bubbleInterval) clearInterval(state.bubbleInterval);
            if (state.rainInterval) clearInterval(state.rainInterval);
            
            elements.playButton.style.animation = 'wiggle 2s infinite ease-in-out'; 
            elements.playButton.classList.remove('clicked');


            startIntro();
        }
        
        init();
    </script>
</body>
</html>
